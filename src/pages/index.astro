---
import Base from '../layouts/Base.astro';
import { calculerSalaireNet } from '../lib/salaire.js';
import salaryData from '../data/salaryData.json';
import financialTips from '../data/financialTips.json';
import advancedDeductions from '../data/advancedDeductions.json';
---

<Base 
  title="Calculateur Salaire Net Qu√©bec 2025 | Simulation Compl√®te et Personnalis√©e"
  description="Le calculateur de salaire le plus complet du Qu√©bec. Calcul en temps r√©el, conseils personnalis√©s, comparaisons sociales et options avanc√©es. D√©couvrez votre vrai net !"
>

<header class="bg-gradient-to-br from-emerald-50 via-white to-blue-50 border-b border-gray-100 shadow-sm sticky top-0 z-50 backdrop-blur-sm">
  <div class="max-w-6xl mx-auto px-4 py-4">
    <div class="flex justify-between items-center">
      <div class="flex items-center space-x-3">
        <div class="w-10 h-10 bg-gradient-to-br from-emerald-500 to-blue-500 rounded-lg flex items-center justify-center">
          <span class="text-white font-bold text-xl">üí∞</span>
        </div>
        <h1 class="text-xl md:text-2xl font-bold bg-gradient-to-r from-emerald-600 to-blue-600 bg-clip-text text-transparent">
          SalaireNet.ca
        </h1>
      </div>
      
      <!-- Province Toggle -->
      <div class="flex items-center space-x-2 bg-white rounded-full p-1 shadow-sm border border-gray-200">
        <button id="toggle-qc" class="province-toggle active px-3 md:px-4 py-2 rounded-full text-xs md:text-sm font-medium transition-all duration-200">
          üçÅ Qu√©bec
        </button>
        <button id="toggle-on" class="province-toggle px-3 md:px-4 py-2 rounded-full text-xs md:text-sm font-medium transition-all duration-200">
          üè¢ Ontario  
        </button>
      </div>
    </div>
  </div>
</header>

<main class="min-h-screen bg-gradient-to-br from-emerald-50 via-white to-blue-50">
  
  <!-- Hero Section -->
  <section class="max-w-7xl mx-auto px-4 py-6 md:py-8">
    
    <div class="text-center mb-6 md:mb-8">
      <h2 class="text-3xl md:text-5xl font-bold text-gray-900 mb-4">
        Calculateur Salaire Net
        <span class="block text-emerald-600" id="province-title">Qu√©bec 2025</span>
      </h2>
      <p class="text-lg md:text-xl text-gray-600 max-w-3xl mx-auto" id="hero-subtitle">
        Le calculateur le plus complet du Qu√©bec avec conseils personnalis√©s
      </p>
    </div>

    <!-- Quick Presets -->
    <div class="flex flex-wrap justify-center gap-2 md:gap-3 mb-6 md:mb-8">
      <button class="preset-btn" data-salary="45000" data-type="salarie">
        üë®‚Äçüíª Dev Junior <span class="block text-xs opacity-75">45k$</span>
      </button>
      <button class="preset-btn" data-salary="75000" data-type="salarie">
        üë®‚Äçüíº Dev Senior <span class="block text-xs opacity-75">75k$</span>
      </button>
      <button class="preset-btn" data-salary="95000" data-type="salarie">
        üöÄ Lead Tech <span class="block text-xs opacity-75">95k$</span>
      </button>
      <button class="preset-btn" data-salary="60000" data-type="freelance">
        üíº Freelance <span class="block text-xs opacity-75">60k$</span>
      </button>
    </div>

    <div class="grid lg:grid-cols-3 gap-6 md:gap-8">
      
      <!-- Main Calculator -->
      <div class="lg:col-span-2">
        <div class="bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden">
          
          <!-- Calculator Header -->
          <div class="bg-gradient-to-r from-emerald-500 to-blue-500 p-4 md:p-6 text-white">
            <h3 class="text-xl md:text-2xl font-bold mb-2">‚ö° Calcul en temps r√©el</h3>
            <p class="text-emerald-100">Saisissez votre salaire pour un calcul instantan√©</p>
          </div>

          <div class="p-4 md:p-6">
            
            <!-- Main Inputs -->
            <div class="grid md:grid-cols-2 gap-4 md:gap-6 mb-6">
              
              <!-- Salary Input -->
              <div class="space-y-3">
                <label class="block text-gray-700 font-semibold">üí∞ Salaire annuel brut</label>
                <div class="relative">
                  <input 
                    type="number" 
                    id="salary-input" 
                    class="w-full p-3 md:p-4 text-lg md:text-xl font-bold border-2 border-gray-200 rounded-xl focus:border-emerald-500 focus:ring-0 transition-colors"
                    placeholder="65000"
                    min="20000"
                    max="500000"
                  />
                  <span class="absolute right-3 md:right-4 top-1/2 transform -translate-y-1/2 text-gray-400 font-medium">CAD $</span>
                </div>
                
                <!-- Visual Slider -->
                <div class="mt-3">
                  <input 
                    type="range" 
                    id="salary-slider" 
                    min="20000" 
                    max="200000" 
                    step="1000"
                    class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider"
                  />
                  <div class="flex justify-between text-xs text-gray-500 mt-1">
                    <span>20k$</span>
                    <span>200k$</span>
                  </div>
                </div>
              </div>

              <!-- Status & Hours -->
              <div class="space-y-3">
                <label class="block text-gray-700 font-semibold">üë§ Votre statut</label>
                <div class="grid grid-cols-2 gap-2 p-1 bg-gray-100 rounded-xl">
                  <button id="status-employee" class="status-btn active py-2 md:py-3 px-3 md:px-4 rounded-lg text-sm font-medium transition-all duration-200">
                    üíº Salari√©
                  </button>
                  <button id="status-freelance" class="status-btn py-2 md:py-3 px-3 md:px-4 rounded-lg text-sm font-medium transition-all duration-200">
                    üöÄ Freelance
                  </button>
                </div>
                
                <div>
                  <label class="block text-gray-600 text-sm font-medium mb-2">‚è∞ Heures/semaine</label>
                  <input 
                    type="number" 
                    id="hours-input" 
                    value="35" 
                    min="20" 
                    max="60"
                    class="w-full p-3 border border-gray-200 rounded-lg focus:border-emerald-500 focus:ring-0"
                  />
                </div>
              </div>
            </div>

            <!-- Results Section -->
            <div id="results-container" class="hidden space-y-6">
              
              <!-- Main Net Result -->
              <div class="bg-gradient-to-r from-emerald-50 to-blue-50 rounded-2xl p-4 md:p-6 border border-emerald-200">
                <div class="text-center">
                  <p class="text-gray-600 mb-2">Votre salaire net annuel</p>
                  <div class="text-3xl md:text-4xl font-bold text-emerald-600 mb-1" id="net-annual">-</div>
                  <p class="text-gray-500">soit <span id="net-monthly" class="font-semibold text-gray-700">-</span> par mois</p>
                </div>
              </div>

              <!-- Accounting Style Breakdown -->
              <div class="bg-gray-50 rounded-2xl p-4 md:p-6 border border-gray-200">
                <h4 class="font-bold text-gray-800 text-lg mb-4">üìä D√©composition comptable</h4>
                
                <div class="space-y-2 font-mono text-sm md:text-base">
                  <div class="flex justify-between items-center py-2 border-b border-gray-200">
                    <span class="text-gray-700">üí∞ Salaire brut annuel :</span>
                    <span class="font-bold text-gray-900" id="breakdown-gross">-</span>
                  </div>
                  <div class="flex justify-between items-center py-1">
                    <span class="text-red-600">‚ûñ Imp√¥t f√©d√©ral :</span>
                    <span class="font-semibold text-red-600" id="breakdown-federal">-</span>
                  </div>
                  <div class="flex justify-between items-center py-1">
                    <span class="text-blue-600" id="breakdown-provincial-label">‚ûñ Imp√¥t provincial (QC) :</span>
                    <span class="font-semibold text-blue-600" id="breakdown-provincial">-</span>
                  </div>
                  <div class="flex justify-between items-center py-1">
                    <span class="text-purple-600">‚ûñ RRQ :</span>
                    <span class="font-semibold text-purple-600" id="breakdown-rrq">-</span>
                  </div>
                  <div class="flex justify-between items-center py-1">
                    <span class="text-orange-600">‚ûñ RQAP :</span>
                    <span class="font-semibold text-orange-600" id="breakdown-rqap">-</span>
                  </div>
                  <div class="flex justify-between items-center py-1" id="breakdown-ae-row">
                    <span class="text-gray-600">‚ûñ Assurance-emploi :</span>
                    <span class="font-semibold text-gray-600" id="breakdown-ae">-</span>
                  </div>
                  
                  <div class="flex justify-between items-center py-3 border-t-2 border-gray-400 font-bold text-lg">
                    <span class="text-emerald-700">‚úÖ SALAIRE NET ANNUEL :</span>
                    <span class="text-emerald-600" id="breakdown-net">-</span>
                  </div>
                </div>
              </div>

              <!-- Time Breakdown -->
              <div class="bg-white rounded-2xl p-4 md:p-6 border border-gray-200">
                <h4 class="font-bold text-gray-800 text-lg mb-4">üóìÔ∏è R√©partition temporelle</h4>
                
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
                  <div class="text-center p-3 bg-emerald-50 rounded-lg">
                    <div class="text-xs text-emerald-600 mb-1">Mensuel</div>
                    <div class="font-bold text-emerald-700" id="time-monthly">-</div>
                  </div>
                  <div class="text-center p-3 bg-blue-50 rounded-lg">
                    <div class="text-xs text-blue-600 mb-1">Bi-mensuel</div>
                    <div class="font-bold text-blue-700" id="time-bimonthly">-</div>
                  </div>
                  <div class="text-center p-3 bg-purple-50 rounded-lg">
                    <div class="text-xs text-purple-600 mb-1">Semaine</div>
                    <div class="font-bold text-purple-700" id="time-weekly">-</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Sidebar -->
      <div class="space-y-4 md:space-y-6">
        
        <!-- Social Comparison -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-4 md:p-6">
          <h3 class="font-bold text-gray-800 mb-4 flex items-center">
            <span class="mr-2">üéØ</span> Votre position sociale
          </h3>
          <div id="social-comparison" class="space-y-3 text-sm">
            <p class="text-gray-600">Saisissez votre salaire pour voir votre position</p>
          </div>
        </div>

        <!-- Financial Recommendations -->
        <div class="bg-gradient-to-br from-emerald-50 to-blue-50 rounded-2xl shadow-lg border border-emerald-200 p-4 md:p-6">
          <h3 class="font-bold text-emerald-800 mb-4 flex items-center">
            <span class="mr-2">üí°</span> Conseils personnalis√©s
          </h3>
          <div id="financial-tips" class="space-y-3 text-sm">
            <p class="text-emerald-700">Des conseils adapt√©s √† votre situation appara√Ætront ici</p>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- CSS styles (inchang√©) -->
<style>
  /* Tous tes styles CSS existants */
  .slider::-webkit-slider-thumb {
    appearance: none;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: linear-gradient(135deg, #10b981, #3b82f6);
    cursor: pointer;
    border: 3px solid white;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  }

  .province-toggle.active {
    background: linear-gradient(135deg, #10b981, #3b82f6);
    color: white;
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
  }

  .status-btn.active {
    background: linear-gradient(135deg, #10b981, #3b82f6);
    color: white;
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
  }

  .preset-btn {
    @apply bg-white hover:bg-emerald-50 border border-emerald-200 hover:border-emerald-300 rounded-xl px-3 md:px-4 py-2 md:py-3 text-xs md:text-sm font-medium text-emerald-700 transition-all duration-200 hover:shadow-md;
  }

  @keyframes shimmer {
  0% { transform: translateX(-100%) skewX(-12deg); }
  100% { transform: translateX(200%) skewX(-12deg); }
}

.animate-shimmer {
  animation: shimmer 1.5s ease-in-out;
}

.shadow-3xl {
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25), 0 0 30px rgba(16, 185, 129, 0.3);
}
</style>

<script define:vars={{ salaryData, financialTips, advancedDeductions }}>
console.log('üöÄ Script charg√© !', { salaryData, financialTips, advancedDeductions });

// URL Management utilities
class UrlManager {
  static parseUrlParams() {
    const params = new URLSearchParams(window.location.search);
    return {
      salaire: parseInt(params.get('salaire')) || 0,
      statut: params.get('statut') || 'salarie',
      province: params.get('province') || 'QC'
    };
  }

  static updateUrl(params) {
    const url = new URL(window.location);
    if (params.salaire > 0) {
      url.searchParams.set('salaire', params.salaire);
      url.searchParams.set('statut', params.statut);
      url.searchParams.set('province', params.province);
    } else {
      url.searchParams.delete('salaire');
      url.searchParams.delete('statut');
      url.searchParams.delete('province');
    }
    window.history.replaceState({}, '', url);
  }

  static generateShareUrl(params) {
    const baseUrl = window.location.origin;
    return `${baseUrl}/?salaire=${params.salaire}&statut=${params.statut}&province=${params.province}`;
  }
}

// Time calculator utility
class TimeCalculator {
  static calculateWorkingDays(netSalary, grossSalary, province) {
    const totalTax = grossSalary - netSalary;
    const taxRate = totalTax / grossSalary;
    
    const workingDaysPerYear = 250;
    const taxDays = Math.round(workingDaysPerYear * taxRate);
    
    const startDate = new Date(new Date().getFullYear(), 0, 1);
    const taxEndDate = new Date(startDate);
    taxEndDate.setDate(startDate.getDate() + taxDays);
    
    return {
      taxDays: taxDays,
      taxEndDate: taxEndDate,
      taxRate: taxRate
    };
  }
}

// Updated salary calculator function with province support
function calculerSalaireNet(salaire, statut = 'salarie', province = 'QC') {
  console.log('üî¢ Calcul c√¥t√© client:', salaire, statut, province);
  
  const isFreelance = statut === 'freelance';
  
  // RRQ/CPP - Different for QC vs ON
  const pensionRate = isFreelance ? 0.128 : 0.064;
  let pension;
  
  if (province === 'QC') {
    pension = Math.min(Math.max(0, salaire - 3500), 71200 - 3500) * pensionRate;
  } else {
    pension = Math.min(Math.max(0, salaire - 3500), 71300 - 3500) * pensionRate;
  }

  // RQAP (Quebec only) vs EI
  let rqap = 0;
  let ae = 0;
  
  if (province === 'QC') {
    rqap = Math.min(salaire, 98000) * (isFreelance ? 0.00878 : 0.00494);
    ae = isFreelance ? 0 : Math.min(salaire, 65700) * 0.0131;
  } else {
    ae = isFreelance ? 0 : Math.min(salaire, 65700) * 0.0131;
  }

  // Federal tax (same for both)
  const fed = calculerPalier(salaire, [
    { limit: 57375, rate: 0.15 },
    { limit: 114750, rate: 0.205 },
    { limit: 177882, rate: 0.26 },
    { limit: 253414, rate: 0.29 },
    { limit: Infinity, rate: 0.33 }
  ]);

  // Provincial tax - DIFFERENT RATES
  const provincialRates = {
    QC: [
      { limit: 53255, rate: 0.14 },
      { limit: 106495, rate: 0.19 },
      { limit: 129590, rate: 0.24 },
      { limit: Infinity, rate: 0.2575 }
    ],
    ON: [
      { limit: 54183, rate: 0.0505 },
      { limit: 108367, rate: 0.0915 },
      { limit: 150000, rate: 0.1116 },
      { limit: 220000, rate: 0.1216 },
      { limit: Infinity, rate: 0.1316 }
    ]
  };

  const prov = calculerPalier(salaire, provincialRates[province]);
  const total = pension + rqap + ae + fed + prov;
  
  return {
    net: Math.round(salaire - total),
    pension: Math.round(pension),
    rqap: Math.round(rqap),
    ae: Math.round(ae),
    fed: Math.round(fed),
    prov: Math.round(prov),
    province: province
  };
}

function calculerPalier(income, brackets) {
  let tax = 0, prev = 0;
  for (const b of brackets) {
    const taxable = Math.min(income, b.limit) - prev;
    if (taxable > 0) {
      tax += taxable * b.rate;
      prev = b.limit;
    } else break;
  }
  return tax;
}

class SalaryCalculator {
  constructor() {
    this.currentProvince = 'QC';
    this.currentStatus = 'salarie';
    this.currentSalary = 0;
    console.log('‚úÖ Calculator initialis√©');
    this.initEventListeners();
    this.loadFromUrl();
  }

  loadFromUrl() {
    const params = UrlManager.parseUrlParams();
    console.log('üîç Param√®tres URL:', params);
    
    if (params.salaire > 0) {
      console.log('üìÇ Chargement depuis URL:', params);
      
      // Set form values
      const salaryInput = document.getElementById('salary-input');
      const salarySlider = document.getElementById('salary-slider');
      
      if (salaryInput) salaryInput.value = params.salaire;
      if (salarySlider) salarySlider.value = params.salaire;
      
      // Set status and province
      this.switchStatus(params.statut);
      this.switchProvince(params.province);
      
      // Calculate
      setTimeout(() => {
        this.calculateSalary(params.salaire);
      }, 100);
    } else {
      // Default calculation
      setTimeout(() => {
        this.calculateSalary(65000);
        const salaryInput = document.getElementById('salary-input');
        const salarySlider = document.getElementById('salary-slider');
        if (salaryInput) salaryInput.value = 65000;
        if (salarySlider) salarySlider.value = 65000;
      }, 500);
    }
  }

  initEventListeners() {
    console.log('üîó Ajout des event listeners...');
    
    document.getElementById('toggle-qc')?.addEventListener('click', () => this.switchProvince('QC'));
    document.getElementById('toggle-on')?.addEventListener('click', () => this.switchProvince('ON'));

    document.getElementById('status-employee')?.addEventListener('click', () => this.switchStatus('salarie'));
    document.getElementById('status-freelance')?.addEventListener('click', () => this.switchStatus('freelance'));

    const salaryInput = document.getElementById('salary-input');
    const salarySlider = document.getElementById('salary-slider');
    
    salaryInput?.addEventListener('input', (e) => {
      const value = parseFloat(e.target.value) || 0;
      if (salarySlider) salarySlider.value = Math.min(value, 200000);
      this.calculateSalary(value);
      this.updateUrl();
    });
    
    salarySlider?.addEventListener('input', (e) => {
      const value = parseFloat(e.target.value);
      if (salaryInput) salaryInput.value = value;
      this.calculateSalary(value);
      this.updateUrl();
    });

    document.querySelectorAll('.preset-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const salary = parseInt(btn.dataset.salary);
        const type = btn.dataset.type;
        console.log('üéØ Preset cliqu√©:', salary, type);
        
        if (salaryInput) salaryInput.value = salary;
        if (salarySlider) salarySlider.value = salary;
        this.switchStatus(type);
        this.calculateSalary(salary);
        this.updateUrl();
      });
    });

    // üÜï Ajout du bouton de partage apr√®s le chargement du DOM
    setTimeout(() => {
      this.addShareButton();
    }, 1000);
  }
addShareButton() {
  if (document.getElementById('share-btn')) return;
  
  const resultsContainer = document.getElementById('results-container');
  if (resultsContainer) {
    const shareContainer = document.createElement('div');
    shareContainer.className = 'mt-6 p-6 bg-gradient-to-br from-emerald-50 via-blue-50 to-purple-50 rounded-2xl border-2 border-dashed border-emerald-200 relative overflow-hidden';
    
    shareContainer.innerHTML = `
      <!-- Animated background particles -->
      <div class="absolute inset-0 overflow-hidden pointer-events-none">
        <div class="absolute top-2 left-4 w-2 h-2 bg-emerald-400 rounded-full animate-ping"></div>
        <div class="absolute top-6 right-8 w-1 h-1 bg-blue-400 rounded-full animate-pulse"></div>
        <div class="absolute bottom-4 left-12 w-1.5 h-1.5 bg-purple-400 rounded-full animate-bounce"></div>
      </div>
      
      <div class="text-center space-y-4 relative">
        <div class="space-y-1">
          <div class="text-lg font-bold text-gray-800 flex items-center justify-center space-x-2">
            <span class="animate-bounce">üéâ</span>
            <span>Ton r√©sultat est pr√™t !</span>
            <span class="animate-bounce" style="animation-delay: 0.1s;">üéâ</span>
          </div>
          <div class="text-sm text-gray-600">
            Impressionne tes coll√®gues avec ce calcul pr√©cis
          </div>
        </div>
        
        <button id="share-btn" class="group relative bg-gradient-to-r from-emerald-500 via-blue-500 to-purple-500 hover:from-emerald-600 hover:via-blue-600 hover:to-purple-600 text-white font-bold py-4 px-8 rounded-2xl shadow-2xl hover:shadow-3xl transform hover:scale-110 transition-all duration-500 w-full max-w-sm mx-auto overflow-hidden">
          
          <!-- Shimmer effect -->
          <div class="absolute inset-0 -skew-x-12 bg-gradient-to-r from-transparent via-white/30 to-transparent opacity-0 group-hover:opacity-100 group-hover:animate-shimmer"></div>
          
          <div class="relative flex items-center justify-center space-x-3">
            <span class="text-2xl transform group-hover:rotate-12 transition-transform duration-300">üöÄ</span>
            <div class="text-center">
              <div class="text-lg font-black">PARTAGER</div>
              <div class="text-xs opacity-90 font-medium">G√©n√®re ton lien perso</div>
            </div>
            <span class="text-2xl transform group-hover:-rotate-12 transition-transform duration-300">üí´</span>
          </div>
        </button>
        
        <div class="flex items-center justify-center space-x-4 text-xs text-gray-500">
          <div class="flex items-center space-x-1">
            <span>‚ö°</span>
            <span>Copie instantan√©e</span>
          </div>
          <div class="w-1 h-1 bg-gray-300 rounded-full"></div>
          <div class="flex items-center space-x-1">
            <span>üîí</span>
            <span>S√©curis√©</span>
          </div>
          <div class="w-1 h-1 bg-gray-300 rounded-full"></div>
          <div class="flex items-center space-x-1">
            <span>üéØ</span>
            <span>URL unique</span>
          </div>
        </div>
      </div>
    `;
    
    const breakdown = resultsContainer.querySelector('.space-y-6');
    if (breakdown) {
      breakdown.appendChild(shareContainer);
    }
    
    const shareBtn = document.getElementById('share-btn');
    if (shareBtn) {
      shareBtn.addEventListener('click', () => this.shareResult());
    }
  }
}

  shareResult() {
  const shareUrl = UrlManager.generateShareUrl({
    salaire: this.currentSalary,
    statut: this.currentStatus,
    province: this.currentProvince
  });

  const result = calculerSalaireNet(this.currentSalary, this.currentStatus, this.currentProvince);
  const netSalary = this.formatCurrency(result.net);
  const statusLabel = this.currentStatus === 'freelance' ? 'freelance' : 'salari√©';
  const provinceLabel = this.currentProvince === 'QC' ? 'Qu√©bec' : 'Ontario';

  console.log('üîó URL de partage:', shareUrl);

  navigator.clipboard.writeText(shareUrl).then(() => {
    const btn = document.getElementById('share-btn');
    if (btn) {
      const originalHTML = btn.innerHTML;
      
      // Animation de succ√®s ultra-satisfaisante
      btn.innerHTML = `
        <div class="relative flex items-center justify-center space-x-3">
          <span class="text-2xl animate-bounce">‚úÖ</span>
          <div class="text-center">
            <div class="text-lg font-black">LIEN COPI√â !</div>
            <div class="text-xs opacity-90 font-medium">Pr√™t √† impressionner</div>
          </div>
          <span class="text-2xl animate-spin">üéâ</span>
        </div>
      `;
      
      btn.classList.remove('from-emerald-500', 'via-blue-500', 'to-purple-500');
      btn.classList.add('from-green-500', 'via-emerald-500', 'to-green-600');
      
      setTimeout(() => {
        btn.innerHTML = originalHTML;
        btn.classList.remove('from-green-500', 'via-emerald-500', 'to-green-600');
        btn.classList.add('from-emerald-500', 'via-blue-500', 'to-purple-500');
      }, 3000);
    }
  }).catch(() => {
    // Fallback avec message viral optimis√©
    const message = `üéØ ${netSalary} net/an comme ${statusLabel} au ${provinceLabel} !\n\n‚ú® Calcule ton salaire ici : ${shareUrl}`;
    
    // Essai de partage natif mobile d'abord
    if (navigator.share) {
      navigator.share({
        title: `üí∞ Mon salaire net : ${netSalary}/an !`,
        text: `D√©couvre combien tu gagnes vraiment avec ce calculateur qu√©b√©cois`,
        url: shareUrl
      });
    } else {
      alert(message);
    }
  });
}

  updateUrl() {
    if (this.currentSalary > 0) {
      UrlManager.updateUrl({
        salaire: this.currentSalary,
        statut: this.currentStatus,
        province: this.currentProvince
      });
      console.log('üîÑ URL mise √† jour:', window.location.href);
    }
  }

  switchProvince(province) {
    console.log('üó∫Ô∏è Switch province:', province);
    this.currentProvince = province;
    
    document.querySelectorAll('.province-toggle').forEach(btn => btn.classList.remove('active'));
    const toggleBtn = document.getElementById(`toggle-${province.toLowerCase()}`);
    if (toggleBtn) toggleBtn.classList.add('active');
    
    const labels = {
      QC: { title: 'Qu√©bec 2025', provincial: '‚ûñ Imp√¥t Qu√©bec :' },
      ON: { title: 'Ontario 2025', provincial: '‚ûñ Imp√¥t Ontario :' }
    };
    
    const titleEl = document.getElementById('province-title');
    const labelEl = document.getElementById('breakdown-provincial-label');
    
    if (titleEl) titleEl.textContent = labels[province].title;
    if (labelEl) labelEl.textContent = labels[province].provincial;
    
    if (this.currentSalary > 0) {
      this.calculateSalary(this.currentSalary);
      this.updateUrl();
    }
  }

  switchStatus(status) {
    console.log('üë§ Switch status:', status);
    this.currentStatus = status;
    
    document.querySelectorAll('.status-btn').forEach(btn => btn.classList.remove('active'));
    const targetBtn = status === 'salarie' ? 'status-employee' : 'status-freelance';
    const statusBtn = document.getElementById(targetBtn);
    if (statusBtn) statusBtn.classList.add('active');
    
    if (this.currentSalary > 0) {
      this.calculateSalary(this.currentSalary);
      this.updateUrl();
    }
  }

  calculateSalary(grossSalary) {
    if (!grossSalary || grossSalary <= 0) {
      console.log('‚ùå Pas de salaire √† calculer');
      const container = document.getElementById('results-container');
      if (container) container.classList.add('hidden');
      return;
    }

    console.log('üî¢ Calcul pour:', grossSalary, this.currentStatus, this.currentProvince);
    this.currentSalary = grossSalary;
    
    const result = calculerSalaireNet(grossSalary, this.currentStatus, this.currentProvince);
    console.log('üìä R√©sultat:', result);
    
    const container = document.getElementById('results-container');
    if (container) {
      container.classList.remove('hidden');
      this.updateResults(result, grossSalary);
      this.updateTimeBreakdown(result.net, grossSalary);
      this.updateSocialComparison(result.net);
      this.updateFinancialTips(result.net);
      
      // Add share button if not already present
      setTimeout(() => this.addShareButton(), 100);
    }
  }

  updateResults(result, grossSalary) {
    console.log('üìù Mise √† jour des r√©sultats:', result);
    
    // Main results
    const netAnnualEl = document.getElementById('net-annual');
    const netMonthlyEl = document.getElementById('net-monthly');
    
    if (netAnnualEl) netAnnualEl.textContent = this.formatCurrency(result.net);
    if (netMonthlyEl) netMonthlyEl.textContent = this.formatCurrency(result.net / 12);

    // Breakdown
    const elements = {
      'breakdown-gross': grossSalary,
      'breakdown-federal': `-${result.fed}`,
      'breakdown-provincial': `-${result.prov}`,
      'breakdown-rrq': `-${result.pension}`,
      'breakdown-rqap': `-${result.rqap}`,
      'breakdown-ae': `-${result.ae}`,
      'breakdown-net': result.net
    };

    Object.entries(elements).forEach(([id, value]) => {
      const el = document.getElementById(id);
      if (el) {
        if (typeof value === 'string' && value.startsWith('-')) {
          el.textContent = value.replace('-', `-${this.formatCurrency(Math.abs(parseFloat(value)))}`);
        } else {
          el.textContent = this.formatCurrency(value);
        }
      }
    });

    // Show/hide AE row for freelancers
    const aeRow = document.getElementById('breakdown-ae-row');
    if (aeRow) {
      if (this.currentStatus === 'freelance') {
        aeRow.classList.add('hidden');
      } else {
        aeRow.classList.remove('hidden');
      }
    }

    this.showProvinceComparison(grossSalary);
  }

  showProvinceComparison(grossSalary) {
    const qcResult = calculerSalaireNet(grossSalary, this.currentStatus, 'QC');
    const onResult = calculerSalaireNet(grossSalary, this.currentStatus, 'ON');
    
    const difference = onResult.net - qcResult.net;
    const betterProvince = difference > 0 ? 'Ontario' : 'Qu√©bec';
    const amount = Math.abs(difference);
    
    let comparisonDiv = document.getElementById('province-comparison');
    if (!comparisonDiv) {
      comparisonDiv = document.createElement('div');
      comparisonDiv.id = 'province-comparison';
      comparisonDiv.className = 'mt-4 p-4 bg-gradient-to-r from-blue-50 to-green-50 rounded-xl border border-blue-200';
      
      const resultsContainer = document.getElementById('results-container');
      const spaceDiv = resultsContainer?.querySelector('.space-y-6');
      if (spaceDiv) {
        spaceDiv.appendChild(comparisonDiv);
      }
    }
    
    comparisonDiv.innerHTML = `
      <h4 class="font-bold text-gray-800 mb-3">üçÅ vs üè¢ Comparaison provinciale</h4>
      <div class="grid grid-cols-2 gap-4 text-sm">
        <div class="text-center p-3 bg-blue-100 rounded-lg">
          <div class="font-semibold text-blue-800">Qu√©bec</div>
          <div class="text-lg font-bold text-blue-600">${this.formatCurrency(qcResult.net)}</div>
          <div class="text-xs text-blue-600">net/ann√©e</div>
        </div>
        <div class="text-center p-3 bg-orange-100 rounded-lg">
          <div class="font-semibold text-orange-800">Ontario</div>
          <div class="text-lg font-bold text-orange-600">${this.formatCurrency(onResult.net)}</div>
          <div class="text-xs text-orange-600">net/ann√©e</div>
        </div>
      </div>
      <div class="text-center mt-3 p-2 bg-white rounded-lg">
        <div class="font-semibold text-gray-800">
          ${betterProvince} gagnant : <span class="text-green-600">+${this.formatCurrency(amount)}</span>
        </div>
        <div class="text-xs text-gray-600 mt-1">
          ${difference > 0 ? 'Ontario a des imp√¥ts plus bas' : 'Qu√©bec reste avantageux'}
        </div>
      </div>
    `;
  }

  updateTimeBreakdown(netAnnual, grossAnnual) {
    console.log('‚è∞ Mise √† jour time breakdown');
    
    const monthly = netAnnual / 12;
    const bimonthly = monthly / 2;
    const weekly = netAnnual / 52;

    const timeElements = {
      'time-monthly': monthly,
      'time-bimonthly': bimonthly,
      'time-weekly': weekly
    };

    Object.entries(timeElements).forEach(([id, value]) => {
      const el = document.getElementById(id);
      if (el) el.textContent = this.formatCurrency(value);
    });

    this.addTaxTimeCalculator(netAnnual, grossAnnual);
  }

  addTaxTimeCalculator(netAnnual, grossAnnual) {
    const timeInfo = TimeCalculator.calculateWorkingDays(netAnnual, grossAnnual, this.currentProvince);
    
    let timeDiv = document.getElementById('tax-time-calculator');
    if (!timeDiv) {
      timeDiv = document.createElement('div');
      timeDiv.id = 'tax-time-calculator';
      timeDiv.className = 'mt-4 p-4 bg-gradient-to-r from-amber-50 to-orange-50 rounded-xl border border-amber-200';
      
      // ‚úÖ S√âLECTEUR CORRIG√â - Trouve le container du time breakdown
      const timeContainer = document.querySelector('#results-container .bg-white.rounded-2xl.p-4');
      if (timeContainer) {
        timeContainer.appendChild(timeDiv);
      }
    }

    const monthNames = ['janvier', 'f√©vrier', 'mars', 'avril', 'mai', 'juin',
      'juillet', 'ao√ªt', 'septembre', 'octobre', 'novembre', 'd√©cembre'];
    
    const taxEndMonth = monthNames[timeInfo.taxEndDate.getMonth()];
    const taxEndDay = timeInfo.taxEndDate.getDate();

    timeDiv.innerHTML = `
      <h4 class="font-bold text-amber-800 mb-3">‚è∞ Calculateur de temps fiscal</h4>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
        <div class="text-center p-3 bg-amber-100 rounded-lg">
          <div class="font-semibold text-amber-800">Tu travailles pour les impots:</div>
          <div class="text-2xl font-bold text-amber-600">${timeInfo.taxDays}</div>
          <div class="text-xs text-amber-600">jours/ann√©e</div>
        </div>
        <div class="text-center p-3 bg-orange-100 rounded-lg">
          <div class="font-semibold text-orange-800">Libre d'imp√¥ts √† partir du</div>
          <div class="text-lg font-bold text-orange-600">${taxEndDay} ${taxEndMonth}</div>
          <div class="text-xs text-orange-600">Date approximative</div>
        </div>
      </div>
      <div class="text-center mt-3 p-2 bg-white rounded-lg">
        <div class="text-sm text-gray-700">
          üè¢ Tu travailles <strong>${(timeInfo.taxRate * 100).toFixed(1)}%</strong> de ton temps pour les gouvernements
        </div>
        <div class="text-xs text-gray-600 mt-1">
          Soit environ <strong>${Math.round(timeInfo.taxRate * 8)} heures par jour</strong> de travail
        </div>
      </div>
    `;
  }

  updateSocialComparison(netSalary) {
    console.log('üéØ Mise √† jour comparaison sociale');
    
    const container = document.getElementById('social-comparison');
    if (!container) return;
    
    const approximateGross = Math.round(netSalary / 0.68);
    console.log('üéØ Comparaison:', { netSalary, approximateGross });
    
    const similarJobs = salaryData.jobComparisons
      .filter(job => Math.abs(job.salary - approximateGross) < 25000)
      .sort((a, b) => Math.abs(a.salary - approximateGross) - Math.abs(b.salary - approximateGross))
      .slice(0, 3);

    const percentile = salaryData.percentileRanges.find(range => 
      approximateGross >= range.minSalary && approximateGross < range.maxSalary
    );

    let betterThan = 50;
    if (approximateGross < 35000) betterThan = 15;
    else if (approximateGross < 50000) betterThan = 35;
    else if (approximateGross < 65000) betterThan = 55;
    else if (approximateGross < 80000) betterThan = 75;
    else if (approximateGross < 100000) betterThan = 85;
    else betterThan = 90;

    const html = `
      <div class="space-y-3">
        <div class="p-3 bg-emerald-50 rounded-lg border border-emerald-200">
          <div class="text-sm font-medium text-emerald-700">Votre position :</div>
          <div class="font-bold text-emerald-600">${percentile?.percentile || 'Top 10%'}</div>
          <div class="text-xs text-emerald-600 mt-1">
            Mieux que <strong>${betterThan}%</strong> des Qu√©b√©cois
          </div>
        </div>
        
        ${similarJobs.length > 0 ? `
          <div class="space-y-2">
            <div class="text-xs font-medium text-gray-700">Salaires similaires (brut) :</div>
            ${similarJobs.map(job => `
              <div class="flex items-center justify-between text-xs p-2 bg-gray-50 rounded">
                <span class="flex items-center">
                  <span class="mr-2">${job.emoji}</span>
                  <span>${job.title}</span>
                </span>
                <span class="font-medium text-gray-700">${this.formatCurrency(job.salary)}</span>
              </div>
            `).join('')}
          </div>
        ` : `
          <div class="text-xs text-gray-600 p-2 bg-gray-50 rounded">
            üéØ Votre salaire est dans une cat√©gorie unique ! Excellent niveau.
          </div>
        `}
        
        <div class="text-xs text-center p-2 rounded ${
          approximateGross > 80000 ? 'bg-green-50 text-green-700' :
          approximateGross > 60000 ? 'bg-blue-50 text-blue-700' :
          approximateGross > 45000 ? 'bg-orange-50 text-orange-700' :
          'bg-amber-50 text-amber-700'
        }">
          ${approximateGross > 80000 ? 'üåü Excellent salaire ! Vous √™tes dans le top 20%' :
            approximateGross > 60000 ? 'üëç Bon salaire, au-dessus de la moyenne qu√©b√©coise' :
            approximateGross > 45000 ? 'üìà Salaire correct, place √† l\'am√©lioration' :
            'üí™ Salaire d\'entr√©e, concentrez-vous sur l\'√©volution'}
        </div>
      </div>
    `;

    container.innerHTML = html;
  }

  updateFinancialTips(netSalary) {
    console.log('üí° Mise √† jour conseils financiers');
    
    const container = document.getElementById('financial-tips');
    if (!container) return;
    
    const monthlyNet = netSalary / 12;
    
    const budgetBreakdown = {
      housing: Math.round(monthlyNet * 0.30),
      transport: Math.round(monthlyNet * 0.15),
      food: Math.round(monthlyNet * 0.12),
      debtMax: Math.round(monthlyNet * 0.20),
      savings: Math.round(monthlyNet * 0.10),
      fun: Math.round(monthlyNet * 0.13)
    };
    
    const recommendation = financialTips.savingsRecommendations.find(rec => 
      netSalary >= rec.minSalary && netSalary <= rec.maxSalary
    ) || financialTips.savingsRecommendations[0];

    const alerts = [];
    if (monthlyNet < 3000) {
      alerts.push({
        icon: '‚ö†Ô∏è',
        text: '√âvitez les dettes de consommation, concentrez-vous sur l\'√©pargne d\'urgence',
        color: 'amber'
      });
    }
    if (monthlyNet > 6000) {
      alerts.push({
        icon: 'üéØ',
        text: 'Excellent niveau ! Maximisez vos REER pour r√©duire vos imp√¥ts',
        color: 'green'
      });
    }
    if (budgetBreakdown.housing > 2000) {
      alerts.push({
        icon: 'üè†',
        text: 'Logement > 2000$/mois ? Consid√©rez la banlieue ou la colocation',
        color: 'blue'
      });
    }

    const html = `
      <div class="space-y-4">
        <div class="bg-white rounded-lg p-3 border border-emerald-100">
          <div class="text-sm font-semibold text-emerald-800 mb-3">üí∞ Budget mensuel recommand√©</div>
          <div class="grid grid-cols-2 gap-2 text-xs">
            <div class="flex justify-between">
              <span class="text-gray-600">üè† Logement max :</span>
              <span class="font-semibold text-emerald-700">${this.formatCurrency(budgetBreakdown.housing)}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">üöó Transport max :</span>
              <span class="font-semibold text-blue-700">${this.formatCurrency(budgetBreakdown.transport)}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">üõí Alimentation :</span>
              <span class="font-semibold text-purple-700">${this.formatCurrency(budgetBreakdown.food)}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">üí≥ Dettes MAX :</span>
              <span class="font-semibold text-red-700">${this.formatCurrency(budgetBreakdown.debtMax)}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">üíæ √âpargne min :</span>
              <span class="font-semibold text-green-700">${this.formatCurrency(budgetBreakdown.savings)}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">üéÆ Loisirs :</span>
              <span class="font-semibold text-orange-700">${this.formatCurrency(budgetBreakdown.fun)}</span>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-3 gap-2 text-xs">
          <div class="text-center p-2 bg-blue-50 rounded">
            <div class="font-semibold text-blue-700">CELIAPP</div>
            <div class="text-blue-600">${this.formatCurrency(recommendation.celiapp)}/mois</div>
          </div>
          <div class="text-center p-2 bg-purple-50 rounded">
            <div class="font-semibold text-purple-700">REER</div>
            <div class="text-purple-600">${this.formatCurrency(recommendation.rrsp)}/mois</div>
          </div>
          <div class="text-center p-2 bg-green-50 rounded">
            <div class="font-semibold text-green-700">CELI</div>
            <div class="text-green-600">${this.formatCurrency(recommendation.tfsa)}/mois</div>
          </div>
        </div>
       
       ${alerts.length > 0 ? `
         <div class="space-y-2">
           ${alerts.map(alert => `
             <div class="flex items-start text-xs p-2 bg-${alert.color}-50 rounded border border-${alert.color}-200">
               <span class="mr-2 mt-0.5">${alert.icon}</span>
               <span class="text-${alert.color}-700">${alert.text}</span>
             </div>
           `).join('')}
         </div>
       ` : ''}
       
       <div class="space-y-2">
         ${recommendation.tips.map(tip => `
           <div class="flex items-start text-xs">
             <span class="text-emerald-500 mr-2 mt-0.5">‚úì</span>
             <span class="text-emerald-700">${tip}</span>
           </div>
         `).join('')}
       </div>
       
       <div class="pt-2 border-t border-emerald-200 space-y-1">
         <div class="text-xs text-emerald-600">
           üí° <strong>R√®gle d'or :</strong> Ne jamais d√©passer ${this.formatCurrency(budgetBreakdown.debtMax)}/mois en dettes
         </div>
         <div class="text-xs text-emerald-600">
           üõ°Ô∏è <strong>Fonds d'urgence :</strong> ${this.formatCurrency(monthlyNet * 6)} (6 mois d'expenses)
         </div>
       </div>
     </div>
   `;

   container.innerHTML = html;
 }

 formatCurrency(amount) {
   return new Intl.NumberFormat('fr-CA', {
     style: 'currency',
     currency: 'CAD',
     minimumFractionDigits: 0,
     maximumFractionDigits: 0
   }).format(amount).replace('CA', '').trim();
 }
}

// Initialisation
document.addEventListener('DOMContentLoaded', () => {
 console.log('üé¨ DOM charg√©, initialisation...');
 new SalaryCalculator();
});
</script>

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1912647362757171"
     crossorigin="anonymous"></script>
          
</Base>